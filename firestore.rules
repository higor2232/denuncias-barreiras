rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================
    // Denúncias Collection
    // ========================================
    match /denuncias/{denunciaId} {
      // Qualquer pessoa pode criar uma denúncia (anônima ou identificada)
      allow create: if validateDenuncia(request.resource.data);
      
      // Leitura pública para o mapa
      allow read: if true;
      
      // Apenas usuários autenticados podem atualizar/deletar e somente para alterar campos permitidos
      allow update, delete: if request.auth != null
                            && isValidStatusUpdate(resource.data, request.resource.data);
    }

    // ========================================
    // Categorias de Denúncia
    // ========================================
    match /report_categories/{categoryId} {
      // Leitura pública (para o formulário)
      allow read: if true;
      
      // Apenas admins autenticados podem gerenciar
      allow write: if request.auth != null;
    }

    // ========================================
    // Usuários Admin
    // ========================================
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // ========================================
    // Funções de Validação
    // ========================================
    function validateDenuncia(data) {
      return data.keys().hasAll(['description', 'category', 'reportType']) &&
             data.description is string &&
             data.description.size() > 0 &&
             data.description.size() <= 5000 &&
             data.category is string &&
             data.category.size() > 0 &&
             data.reportType in ['anonymous', 'identified'];
    }

    // Permite apenas mudanças válidas de status no fluxo definido
    function isValidStatusUpdate(before, after) {
      // Lista de status permitidos
      let allowed = ['pendente', 'em_analise', 'aprovada', 'resolvida', 'rejeitada'];

      // Todos os campos, exceto status, devem permanecer iguais
      return before.diff(after).changedKeys().hasOnly(['status'])
             && after.status in allowed;
    }
  }
}