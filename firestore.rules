rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ========================================
    // Denúncias Collection
    // ========================================
    match /denuncias/{denunciaId} {
      // Qualquer pessoa pode criar uma denúncia (anônima ou identificada)
      allow create: if validateDenuncia(request.resource.data);
      
      // Leitura pública para o mapa
      allow read: if true;
      
      // Apenas admins autenticados podem atualizar/deletar
      allow update, delete: if request.auth != null;
    }

    // ========================================
    // Categorias de Denúncia
    // ========================================
    match /report_categories/{categoryId} {
      // Leitura pública (para o formulário)
      allow read: if true;
      
      // Apenas admins autenticados podem gerenciar
      allow write: if request.auth != null;
    }

    // ========================================
    // Usuários Admin
    // ========================================
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if request.auth != null && request.auth.uid == userId;
    }

    // ========================================
    // Funções de Validação
    // ========================================
    function validateDenuncia(data) {
      return data.keys().hasAll(['description', 'category', 'reportType']) &&
             data.description is string &&
             data.description.size() > 0 &&
             data.description.size() <= 5000 &&
             data.category is string &&
             data.category.size() > 0 &&
             data.reportType in ['anonymous', 'identified'];
    }
  }
}